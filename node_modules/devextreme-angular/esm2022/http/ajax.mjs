/*!
 * devextreme-angular
 * Version: 24.1.3
 * Build date: Tue Jun 11 2024
 *
 * Copyright (c) 2012 - 2024 Developer Express Inc. ALL RIGHTS RESERVED
 *
 * This software may be modified and distributed under the terms
 * of the MIT license. See the LICENSE file in the root of the project for details.
 *
 * https://github.com/DevExpress/devextreme-angular
 */
/* eslint-disable @typescript-eslint/no-floating-promises */
import { HttpEventType, HttpParams, } from '@angular/common/http';
import { throwError, Subject } from 'rxjs';
import { takeUntil, timeoutWith } from 'rxjs/operators';
import { Deferred } from 'devextreme/core/utils/deferred';
import { isDefined } from 'devextreme/core/utils/type';
import { getWindow } from 'devextreme/core/utils/window';
import { isCrossDomain, evalCrossDomainScript, getRequestOptions, getJsonpCallbackName, getRequestHeaders as getAjaxRequestHeaders, getAcceptHeader, getMethod, evalScript, } from 'devextreme/core/utils/ajax_utils';
const PARSER_ERROR = 'parsererror';
const SUCCESS = 'success';
const ERROR = 'error';
const NO_CONTENT = 'nocontent';
const TIMEOUT = 'timeout';
const STATUS_ABORT = 0;
const CONTENT_TYPE = 'Content-Type';
const URLENCODED = 'application/x-www-form-urlencoded';
function assignResponseProps(xhrSurrogate, response) {
    const getResponseHeader = (name) => response.headers.get(name);
    function makeResponseText() {
        const body = 'error' in response ? response.error : response.body;
        if (typeof body !== 'string' || String(getResponseHeader(CONTENT_TYPE)).startsWith('application/json')) {
            return JSON.stringify(body);
        }
        return body;
    }
    Object.assign(xhrSurrogate, {
        status: response.status,
        statusText: response.statusText,
        getResponseHeader,
        responseText: makeResponseText(),
    });
    return xhrSurrogate;
}
function isGetMethod(options) {
    return getMethod(options) === 'GET';
}
function isCacheNeed(options) {
    if (options.cache === undefined) {
        return !(isUsedScript(options) || isUsedJSONP(options));
    }
    return options.cache;
}
function isUsedScript(options) {
    return options.dataType === 'script';
}
function isUsedJSONP(options) {
    return options.dataType === 'jsonp';
}
function getRequestHeaders(options) {
    const headers = getAjaxRequestHeaders(options);
    const { upload } = options;
    if (!headers.Accept) {
        headers.Accept = getAcceptHeader(options);
    }
    if (!upload && !isGetMethod(options) && !headers[CONTENT_TYPE]) {
        headers[CONTENT_TYPE] = options.contentType || `${URLENCODED};charset=utf-8`;
    }
    return Object.keys(headers).reduce((acc, key) => {
        if (isDefined(headers[key])) {
            acc[key] = headers[key];
        }
        return acc;
    }, {});
}
function rejectIfAborted(deferred, xhrSurrogate, callback) {
    if (xhrSurrogate.aborted) {
        deferred.reject({ status: STATUS_ABORT, statusText: 'aborted', ok: false });
        callback?.();
    }
}
function getJsonpParameters(options) {
    const patchedOptions = { ...options };
    const callbackName = getJsonpCallbackName(patchedOptions);
    return { callbackName, data: patchedOptions.data };
}
function addJsonpCallback(callbackName, deferred, xhrSurrogate) {
    getWindow()[callbackName] = (data) => deferred.resolve(data, SUCCESS, xhrSurrogate);
}
function sendRequestByScript(url, deferred, xhrSurrogate) {
    evalCrossDomainScript(url).then(() => deferred.resolve(null, SUCCESS, xhrSurrogate), () => deferred.reject(xhrSurrogate, ERROR));
}
function getRequestCallbacks(options, deferred, xhrSurrogate) {
    return {
        next(response) {
            if (isUsedJSONP(options)) {
                return options.crossDomain
                    ? deferred.resolve(response, 'success', assignResponseProps(xhrSurrogate, response))
                    : evalScript(response.body);
            }
            if (isUsedScript(options)) {
                evalScript(response.body);
            }
            return deferred.resolve(response.body, response.body ? 'success' : NO_CONTENT, assignResponseProps(xhrSurrogate, response));
        },
        error(error) {
            error = error && typeof error === 'object' ? error : { error };
            let errorStatus = error?.statusText === TIMEOUT ? TIMEOUT : 'error';
            errorStatus = options.dataType === 'json' && error?.message?.includes?.('parsing')
                ? PARSER_ERROR
                : errorStatus;
            return deferred.reject(assignResponseProps(xhrSurrogate, { status: 400, ...error }), errorStatus, error);
        },
        complete() {
            rejectIfAborted(deferred, xhrSurrogate);
        },
    };
}
function getUploadCallbacks(options, deferred, xhrSurrogate) {
    let total = 0;
    let isUploadStarted = false;
    return {
        next: (event) => {
            if (!isUploadStarted
                && [HttpEventType.UploadProgress, HttpEventType.Sent].includes(event.type)) {
                options.upload.onloadstart?.(event);
                isUploadStarted = true;
            }
            if (event.type === HttpEventType.UploadProgress) {
                total += event.loaded;
                options.upload.onprogress?.({ ...event, total });
            }
            else if (event.type === HttpEventType.Response) {
                return deferred.resolve(xhrSurrogate, SUCCESS);
            }
            return null;
        },
        error(error) {
            error = error && typeof error === 'object' ? error : { error };
            return deferred.reject(assignResponseProps(xhrSurrogate, { status: 400, ...error }), error.status, error);
        },
        complete() {
            rejectIfAborted(deferred, xhrSurrogate, () => {
                options.upload?.onabort?.(xhrSurrogate);
            });
        },
    };
}
export const sendRequestFactory = (httpClient) => (options) => {
    const abort$ = new Subject();
    const deferred = Deferred();
    const result = deferred.promise();
    const isGet = isGetMethod(options);
    const isJSONP = isUsedJSONP(options);
    const isScript = isUsedScript(options);
    options.crossDomain = isCrossDomain(options.url);
    options.cache = isCacheNeed(options);
    const headers = getRequestHeaders(options);
    const xhrSurrogate = {
        type: 'XMLHttpRequestSurrogate',
        aborted: false,
        abort() {
            this.aborted = true;
            abort$.next();
        },
    };
    result.abort = () => xhrSurrogate.abort();
    if (!options.crossDomain && isJSONP) {
        const { callbackName, data } = getJsonpParameters(options);
        options.data = { ...options.data, ...data };
        addJsonpCallback(callbackName, deferred, xhrSurrogate);
    }
    const { url, parameters: data } = getRequestOptions(options, headers);
    const { upload, beforeSend, xhrFields } = options;
    beforeSend?.(xhrSurrogate);
    if (options.crossDomain && isScript && !xhrSurrogate.aborted) {
        sendRequestByScript(url, deferred, xhrSurrogate);
        return result;
    }
    if (options.cache === false && isGet && data) {
        data._ = Date.now() + 1;
    }
    const makeBody = () => (!upload && typeof data === 'object' && headers[CONTENT_TYPE].indexOf(URLENCODED) === 0
        ? Object.keys(data).reduce((httpParams, key) => httpParams.set(key, data[key]), new HttpParams()).toString()
        : data);
    const body = isGet ? undefined : makeBody();
    const params = isGet ? data : undefined;
    const request = options.crossDomain && isJSONP
        ? httpClient.jsonp(url, options.jsonp || 'callback')
        : httpClient.request(getMethod(options), url, {
            params,
            body,
            headers,
            reportProgress: true,
            withCredentials: xhrFields?.withCredentials,
            observe: upload ? 'events' : 'response',
            responseType: options.responseType || (isScript || isJSONP ? 'text' : options.dataType),
        });
    const subscriptionCallbacks = upload
        ? getUploadCallbacks
        : getRequestCallbacks;
    request.pipe.apply(request, [
        takeUntil(abort$),
        ...options.timeout
            ? [timeoutWith(options.timeout, throwError({ statusText: TIMEOUT, status: 0, ok: false }))]
            : [],
    ]).subscribe(subscriptionCallbacks(options, deferred, xhrSurrogate));
    return result;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWpheC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2Rpc3QvaHR0cC9hamF4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7OztHQVdHO0FBRUgsNERBQTREO0FBQzVELE9BQU8sRUFDTyxhQUFhLEVBQUUsVUFBVSxHQUN0QyxNQUFNLHNCQUFzQixDQUFDO0FBQzlCLE9BQU8sRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFFBQVEsRUFBZSxNQUFNLGdDQUFnQyxDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDekQsT0FBTyxFQUNMLGFBQWEsRUFDYixxQkFBcUIsRUFDckIsaUJBQWlCLEVBQ2pCLG9CQUFvQixFQUNwQixpQkFBaUIsSUFBSSxxQkFBcUIsRUFDMUMsZUFBZSxFQUNmLFNBQVMsRUFDVCxVQUFVLEdBQ1gsTUFBTSxrQ0FBa0MsQ0FBQztBQWUxQyxNQUFNLFlBQVksR0FBRyxhQUFhLENBQUM7QUFDbkMsTUFBTSxPQUFPLEdBQUcsU0FBUyxDQUFDO0FBQzFCLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQztBQUN0QixNQUFNLFVBQVUsR0FBRyxXQUFXLENBQUM7QUFDL0IsTUFBTSxPQUFPLEdBQUcsU0FBUyxDQUFDO0FBQzFCLE1BQU0sWUFBWSxHQUFHLENBQUMsQ0FBQztBQUN2QixNQUFNLFlBQVksR0FBRyxjQUFjLENBQUM7QUFDcEMsTUFBTSxVQUFVLEdBQUcsbUNBQW1DLENBQUM7QUFFdkQsU0FBUyxtQkFBbUIsQ0FBQyxZQUEwQixFQUFFLFFBQStDO0lBQ3RHLE1BQU0saUJBQWlCLEdBQUcsQ0FBQyxJQUFZLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRXZFLFNBQVMsZ0JBQWdCO1FBQ3ZCLE1BQU0sSUFBSSxHQUFHLE9BQU8sSUFBSSxRQUFRLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7UUFFbEUsSUFBSSxPQUFPLElBQUksS0FBSyxRQUFRLElBQUksTUFBTSxDQUFDLGlCQUFpQixDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLEVBQUU7WUFDdEcsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzdCO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUU7UUFDMUIsTUFBTSxFQUFFLFFBQVEsQ0FBQyxNQUFNO1FBQ3ZCLFVBQVUsRUFBRSxRQUFRLENBQUMsVUFBVTtRQUMvQixpQkFBaUI7UUFDakIsWUFBWSxFQUFFLGdCQUFnQixFQUFFO0tBQ2pDLENBQUMsQ0FBQztJQUVILE9BQU8sWUFBWSxDQUFDO0FBQ3RCLENBQUM7QUFFRCxTQUFTLFdBQVcsQ0FBQyxPQUFnQjtJQUNuQyxPQUFPLFNBQVMsQ0FBQyxPQUFPLENBQUMsS0FBSyxLQUFLLENBQUM7QUFDdEMsQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLE9BQWdCO0lBQ25DLElBQUksT0FBTyxDQUFDLEtBQUssS0FBSyxTQUFTLEVBQUU7UUFDL0IsT0FBTyxDQUFDLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxJQUFJLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0tBQ3pEO0lBRUQsT0FBTyxPQUFPLENBQUMsS0FBSyxDQUFDO0FBQ3ZCLENBQUM7QUFFRCxTQUFTLFlBQVksQ0FBQyxPQUFnQjtJQUNwQyxPQUFPLE9BQU8sQ0FBQyxRQUFRLEtBQUssUUFBUSxDQUFDO0FBQ3ZDLENBQUM7QUFFRCxTQUFTLFdBQVcsQ0FBQyxPQUFnQjtJQUNuQyxPQUFPLE9BQU8sQ0FBQyxRQUFRLEtBQUssT0FBTyxDQUFDO0FBQ3RDLENBQUM7QUFFRCxTQUFTLGlCQUFpQixDQUFDLE9BQWdCO0lBQ3pDLE1BQU0sT0FBTyxHQUFHLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQy9DLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxPQUFPLENBQUM7SUFFM0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUU7UUFDbkIsT0FBTyxDQUFDLE1BQU0sR0FBRyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDM0M7SUFFRCxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxFQUFFO1FBQzlELE9BQU8sQ0FBQyxZQUFZLENBQUMsR0FBRyxPQUFPLENBQUMsV0FBVyxJQUFJLEdBQUcsVUFBVSxnQkFBZ0IsQ0FBQztLQUM5RTtJQUVELE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUU7UUFDOUMsSUFBSSxTQUFTLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7WUFDM0IsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUN6QjtRQUNELE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQ1QsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUFDLFFBQXdCLEVBQUUsWUFBMEIsRUFBRSxRQUFxQjtJQUNsRyxJQUFJLFlBQVksQ0FBQyxPQUFPLEVBQUU7UUFDeEIsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUM1RSxRQUFRLEVBQUUsRUFBRSxDQUFDO0tBQ2Q7QUFDSCxDQUFDO0FBRUQsU0FBUyxrQkFBa0IsQ0FBQyxPQUFnQjtJQUMxQyxNQUFNLGNBQWMsR0FBRyxFQUFFLEdBQUcsT0FBTyxFQUFFLENBQUM7SUFDdEMsTUFBTSxZQUFZLEdBQUcsb0JBQW9CLENBQUMsY0FBYyxDQUFDLENBQUM7SUFFMUQsT0FBTyxFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUUsY0FBYyxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ3JELENBQUM7QUFFRCxTQUFTLGdCQUFnQixDQUFDLFlBQW9CLEVBQUUsUUFBd0IsRUFBRSxZQUEwQjtJQUNsRyxTQUFTLEVBQUUsQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLFlBQVksQ0FBQyxDQUFDO0FBQ3RGLENBQUM7QUFFRCxTQUFTLG1CQUFtQixDQUFDLEdBQVcsRUFBRSxRQUF3QixFQUFFLFlBQTBCO0lBQzVGLHFCQUFxQixDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FDN0IsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLFlBQVksQ0FBQyxFQUNuRCxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSxLQUFLLENBQUMsQ0FDM0MsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLG1CQUFtQixDQUFDLE9BQWdCLEVBQUUsUUFBd0IsRUFBRSxZQUEwQjtJQUNqRyxPQUFPO1FBQ0wsSUFBSSxDQUFDLFFBQTJCO1lBQzlCLElBQUksV0FBVyxDQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUN4QixPQUFPLE9BQU8sQ0FBQyxXQUFXO29CQUN4QixDQUFDLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLG1CQUFtQixDQUFDLFlBQVksRUFBRSxRQUFRLENBQUMsQ0FBQztvQkFDcEYsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDL0I7WUFFRCxJQUFJLFlBQVksQ0FBQyxPQUFPLENBQUMsRUFBRTtnQkFDekIsVUFBVSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUMzQjtZQUVELE9BQU8sUUFBUSxDQUFDLE9BQU8sQ0FDckIsUUFBUSxDQUFDLElBQUksRUFDYixRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFVBQVUsRUFDdEMsbUJBQW1CLENBQUMsWUFBWSxFQUFFLFFBQVEsQ0FBQyxDQUM1QyxDQUFDO1FBQ0osQ0FBQztRQUNELEtBQUssQ0FBQyxLQUF3QjtZQUM1QixLQUFLLEdBQUcsS0FBSyxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBa0MsQ0FBQztZQUMvRixJQUFJLFdBQVcsR0FBRyxLQUFLLEVBQUUsVUFBVSxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7WUFFcEUsV0FBVyxHQUFHLE9BQU8sQ0FBQyxRQUFRLEtBQUssTUFBTSxJQUFJLEtBQUssRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLENBQUMsU0FBUyxDQUFDO2dCQUNoRixDQUFDLENBQUMsWUFBWTtnQkFDZCxDQUFDLENBQUMsV0FBVyxDQUFDO1lBRWhCLE9BQU8sUUFBUSxDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxZQUFZLEVBQUUsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsS0FBSyxFQUF1QixDQUFDLEVBQUUsV0FBVyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2hJLENBQUM7UUFDRCxRQUFRO1lBQ04sZUFBZSxDQUFDLFFBQVEsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUMxQyxDQUFDO0tBQ0YsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLGtCQUFrQixDQUFDLE9BQWdCLEVBQUUsUUFBd0IsRUFBRSxZQUEwQjtJQUNoRyxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7SUFDZCxJQUFJLGVBQWUsR0FBRyxLQUFLLENBQUM7SUFFNUIsT0FBTztRQUNMLElBQUksRUFBRSxDQUFDLEtBQXdCLEVBQUUsRUFBRTtZQUNqQyxJQUFJLENBQUMsZUFBZTttQkFDYixDQUFDLGFBQWEsQ0FBQyxjQUFjLEVBQUUsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQzlFLE9BQU8sQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ3BDLGVBQWUsR0FBRyxJQUFJLENBQUM7YUFDeEI7WUFFRCxJQUFJLEtBQUssQ0FBQyxJQUFJLEtBQUssYUFBYSxDQUFDLGNBQWMsRUFBRTtnQkFDL0MsS0FBSyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUM7Z0JBQ3RCLE9BQU8sQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLENBQUMsRUFBRSxHQUFHLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO2FBQ2xEO2lCQUFNLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxhQUFhLENBQUMsUUFBUSxFQUFFO2dCQUNoRCxPQUFPLFFBQVEsQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLE9BQU8sQ0FBQyxDQUFDO2FBQ2hEO1lBQ0QsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBQ0QsS0FBSyxDQUFDLEtBQXdCO1lBQzVCLEtBQUssR0FBRyxLQUFLLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFrQyxDQUFDO1lBQy9GLE9BQU8sUUFBUSxDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxZQUFZLEVBQUUsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsS0FBSyxFQUF1QixDQUFDLEVBQUUsS0FBSyxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNqSSxDQUFDO1FBQ0QsUUFBUTtZQUNOLGVBQWUsQ0FBQyxRQUFRLEVBQUUsWUFBWSxFQUFFLEdBQUcsRUFBRTtnQkFDM0MsT0FBTyxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUMxQyxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUM7S0FDRixDQUFDO0FBQ0osQ0FBQztBQUVELE1BQU0sQ0FBQyxNQUFNLGtCQUFrQixHQUFHLENBQUMsVUFBc0IsRUFBRSxFQUFFLENBQUMsQ0FBQyxPQUFnQixFQUFFLEVBQUU7SUFDakYsTUFBTSxNQUFNLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztJQUNuQyxNQUFNLFFBQVEsR0FBbUIsUUFBUSxFQUFFLENBQUM7SUFDNUMsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLE9BQU8sRUFBWSxDQUFDO0lBQzVDLE1BQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNuQyxNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDckMsTUFBTSxRQUFRLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRXZDLE9BQU8sQ0FBQyxXQUFXLEdBQUcsYUFBYSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNqRCxPQUFPLENBQUMsS0FBSyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUVyQyxNQUFNLE9BQU8sR0FBRyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUMzQyxNQUFNLFlBQVksR0FBaUI7UUFDakMsSUFBSSxFQUFFLHlCQUF5QjtRQUMvQixPQUFPLEVBQUUsS0FBSztRQUNkLEtBQUs7WUFDSCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztZQUNwQixNQUFNLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDaEIsQ0FBQztLQUNGLENBQUM7SUFFRixNQUFNLENBQUMsS0FBSyxHQUFHLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUUxQyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsSUFBSSxPQUFPLEVBQUU7UUFDbkMsTUFBTSxFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUUsR0FBRyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUUzRCxPQUFPLENBQUMsSUFBSSxHQUFHLEVBQUUsR0FBRyxPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsSUFBSSxFQUFFLENBQUM7UUFFNUMsZ0JBQWdCLENBQUMsWUFBWSxFQUFFLFFBQVEsRUFBRSxZQUFZLENBQUMsQ0FBQztLQUN4RDtJQUVELE1BQU0sRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxHQUFHLGlCQUFpQixDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztJQUN0RSxNQUFNLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsR0FBRyxPQUFPLENBQUM7SUFFbEQsVUFBVSxFQUFFLENBQUMsWUFBWSxDQUFDLENBQUM7SUFFM0IsSUFBSSxPQUFPLENBQUMsV0FBVyxJQUFJLFFBQVEsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUU7UUFDNUQsbUJBQW1CLENBQUMsR0FBRyxFQUFFLFFBQVEsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUNqRCxPQUFPLE1BQU0sQ0FBQztLQUNmO0lBRUQsSUFBSSxPQUFPLENBQUMsS0FBSyxLQUFLLEtBQUssSUFBSSxLQUFLLElBQUksSUFBSSxFQUFFO1FBQzVDLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztLQUN6QjtJQUVELE1BQU0sUUFBUSxHQUFHLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLElBQUksT0FBTyxJQUFJLEtBQUssUUFBUSxJQUFJLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQztRQUM1RyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQ3hCLENBQUMsVUFBVSxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQ25ELElBQUksVUFBVSxFQUFFLENBQ2pCLENBQUMsUUFBUSxFQUFFO1FBQ1osQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRVYsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQzVDLE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7SUFFeEMsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLFdBQVcsSUFBSSxPQUFPO1FBQzVDLENBQUMsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsS0FBSyxJQUFJLFVBQVUsQ0FBQztRQUNwRCxDQUFDLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FDbEIsU0FBUyxDQUFDLE9BQU8sQ0FBQyxFQUNsQixHQUFHLEVBQ0g7WUFDRSxNQUFNO1lBQ04sSUFBSTtZQUNKLE9BQU87WUFDUCxjQUFjLEVBQUUsSUFBSTtZQUNwQixlQUFlLEVBQUUsU0FBUyxFQUFFLGVBQWU7WUFDM0MsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxVQUFVO1lBQ3ZDLFlBQVksRUFBRSxPQUFPLENBQUMsWUFBWSxJQUFJLENBQUMsUUFBUSxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDO1NBQ3hGLENBQ0YsQ0FBQztJQUVKLE1BQU0scUJBQXFCLEdBQUcsTUFBTTtRQUNsQyxDQUFDLENBQUMsa0JBQWtCO1FBQ3BCLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQztJQUV4QixPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUU7UUFDMUIsU0FBUyxDQUFDLE1BQU0sQ0FBUTtRQUN4QixHQUFHLE9BQU8sQ0FBQyxPQUFPO1lBQ2hCLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBUSxDQUFDO1lBQ2xHLENBQUMsQ0FBQyxFQUFFO0tBQ1AsQ0FBQyxDQUFDLFNBQVMsQ0FDVixxQkFBcUIsQ0FBQyxPQUFPLEVBQUUsUUFBUSxFQUFFLFlBQVksQ0FBQyxDQUN2RCxDQUFDO0lBRUYsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBkZXZleHRyZW1lLWFuZ3VsYXJcbiAqIFZlcnNpb246IDI0LjEuM1xuICogQnVpbGQgZGF0ZTogVHVlIEp1biAxMSAyMDI0XG4gKlxuICogQ29weXJpZ2h0IChjKSAyMDEyIC0gMjAyNCBEZXZlbG9wZXIgRXhwcmVzcyBJbmMuIEFMTCBSSUdIVFMgUkVTRVJWRURcbiAqXG4gKiBUaGlzIHNvZnR3YXJlIG1heSBiZSBtb2RpZmllZCBhbmQgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIHRlcm1zXG4gKiBvZiB0aGUgTUlUIGxpY2Vuc2UuIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IG9mIHRoZSBwcm9qZWN0IGZvciBkZXRhaWxzLlxuICpcbiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9EZXZFeHByZXNzL2RldmV4dHJlbWUtYW5ndWxhclxuICovXG5cbi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uby1mbG9hdGluZy1wcm9taXNlcyAqL1xyXG5pbXBvcnQge1xyXG4gIEh0dHBDbGllbnQsIEh0dHBFdmVudFR5cGUsIEh0dHBQYXJhbXMsIEh0dHBFdmVudCwgSHR0cEVycm9yUmVzcG9uc2UsIEh0dHBSZXNwb25zZSxcclxufSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IHRocm93RXJyb3IsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgdGFrZVVudGlsLCB0aW1lb3V0V2l0aCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgRGVmZXJyZWQsIERlZmVycmVkT2JqIH0gZnJvbSAnZGV2ZXh0cmVtZS9jb3JlL3V0aWxzL2RlZmVycmVkJztcclxuaW1wb3J0IHsgaXNEZWZpbmVkIH0gZnJvbSAnZGV2ZXh0cmVtZS9jb3JlL3V0aWxzL3R5cGUnO1xyXG5pbXBvcnQgeyBnZXRXaW5kb3cgfSBmcm9tICdkZXZleHRyZW1lL2NvcmUvdXRpbHMvd2luZG93JztcclxuaW1wb3J0IHtcclxuICBpc0Nyb3NzRG9tYWluLFxyXG4gIGV2YWxDcm9zc0RvbWFpblNjcmlwdCxcclxuICBnZXRSZXF1ZXN0T3B0aW9ucyxcclxuICBnZXRKc29ucENhbGxiYWNrTmFtZSxcclxuICBnZXRSZXF1ZXN0SGVhZGVycyBhcyBnZXRBamF4UmVxdWVzdEhlYWRlcnMsXHJcbiAgZ2V0QWNjZXB0SGVhZGVyLFxyXG4gIGdldE1ldGhvZCxcclxuICBldmFsU2NyaXB0LFxyXG59IGZyb20gJ2RldmV4dHJlbWUvY29yZS91dGlscy9hamF4X3V0aWxzJztcclxuXHJcbnR5cGUgUmVzdWx0ID0gUHJvbWlzZTxhbnk+ICYgeyBhYm9ydDogKCkgPT4gdm9pZCB9O1xyXG50eXBlIERlZmVycmVkUmVzdWx0ID0gRGVmZXJyZWRPYmo8YW55PjtcclxuaW50ZXJmYWNlIE9wdGlvbnMge1xyXG4gIHVybDogc3RyaW5nO1xyXG4gIFtrZXk6IHN0cmluZ106IGFueTtcclxufVxyXG5cclxuaW50ZXJmYWNlIFhIUlN1cnJvZ2F0ZSB7XHJcbiAgdHlwZT86IHN0cmluZztcclxuICBhYm9ydGVkOiBib29sZWFuO1xyXG4gIGFib3J0OiAoKSA9PiB2b2lkO1xyXG59XHJcblxyXG5jb25zdCBQQVJTRVJfRVJST1IgPSAncGFyc2VyZXJyb3InO1xyXG5jb25zdCBTVUNDRVNTID0gJ3N1Y2Nlc3MnO1xyXG5jb25zdCBFUlJPUiA9ICdlcnJvcic7XHJcbmNvbnN0IE5PX0NPTlRFTlQgPSAnbm9jb250ZW50JztcclxuY29uc3QgVElNRU9VVCA9ICd0aW1lb3V0JztcclxuY29uc3QgU1RBVFVTX0FCT1JUID0gMDtcclxuY29uc3QgQ09OVEVOVF9UWVBFID0gJ0NvbnRlbnQtVHlwZSc7XHJcbmNvbnN0IFVSTEVOQ09ERUQgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJztcclxuXHJcbmZ1bmN0aW9uIGFzc2lnblJlc3BvbnNlUHJvcHMoeGhyU3Vycm9nYXRlOiBYSFJTdXJyb2dhdGUsIHJlc3BvbnNlOiBIdHRwUmVzcG9uc2U8YW55PiB8IEh0dHBFcnJvclJlc3BvbnNlKSB7XHJcbiAgY29uc3QgZ2V0UmVzcG9uc2VIZWFkZXIgPSAobmFtZTogc3RyaW5nKSA9PiByZXNwb25zZS5oZWFkZXJzLmdldChuYW1lKTtcclxuXHJcbiAgZnVuY3Rpb24gbWFrZVJlc3BvbnNlVGV4dCgpIHtcclxuICAgIGNvbnN0IGJvZHkgPSAnZXJyb3InIGluIHJlc3BvbnNlID8gcmVzcG9uc2UuZXJyb3IgOiByZXNwb25zZS5ib2R5O1xyXG5cclxuICAgIGlmICh0eXBlb2YgYm9keSAhPT0gJ3N0cmluZycgfHwgU3RyaW5nKGdldFJlc3BvbnNlSGVhZGVyKENPTlRFTlRfVFlQRSkpLnN0YXJ0c1dpdGgoJ2FwcGxpY2F0aW9uL2pzb24nKSkge1xyXG4gICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoYm9keSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGJvZHk7XHJcbiAgfVxyXG5cclxuICBPYmplY3QuYXNzaWduKHhoclN1cnJvZ2F0ZSwge1xyXG4gICAgc3RhdHVzOiByZXNwb25zZS5zdGF0dXMsXHJcbiAgICBzdGF0dXNUZXh0OiByZXNwb25zZS5zdGF0dXNUZXh0LFxyXG4gICAgZ2V0UmVzcG9uc2VIZWFkZXIsXHJcbiAgICByZXNwb25zZVRleHQ6IG1ha2VSZXNwb25zZVRleHQoKSxcclxuICB9KTtcclxuXHJcbiAgcmV0dXJuIHhoclN1cnJvZ2F0ZTtcclxufVxyXG5cclxuZnVuY3Rpb24gaXNHZXRNZXRob2Qob3B0aW9uczogT3B0aW9ucykge1xyXG4gIHJldHVybiBnZXRNZXRob2Qob3B0aW9ucykgPT09ICdHRVQnO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpc0NhY2hlTmVlZChvcHRpb25zOiBPcHRpb25zKSB7XHJcbiAgaWYgKG9wdGlvbnMuY2FjaGUgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgcmV0dXJuICEoaXNVc2VkU2NyaXB0KG9wdGlvbnMpIHx8IGlzVXNlZEpTT05QKG9wdGlvbnMpKTtcclxuICB9XHJcblxyXG4gIHJldHVybiBvcHRpb25zLmNhY2hlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpc1VzZWRTY3JpcHQob3B0aW9uczogT3B0aW9ucykge1xyXG4gIHJldHVybiBvcHRpb25zLmRhdGFUeXBlID09PSAnc2NyaXB0JztcclxufVxyXG5cclxuZnVuY3Rpb24gaXNVc2VkSlNPTlAob3B0aW9uczogT3B0aW9ucykge1xyXG4gIHJldHVybiBvcHRpb25zLmRhdGFUeXBlID09PSAnanNvbnAnO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRSZXF1ZXN0SGVhZGVycyhvcHRpb25zOiBPcHRpb25zKSB7XHJcbiAgY29uc3QgaGVhZGVycyA9IGdldEFqYXhSZXF1ZXN0SGVhZGVycyhvcHRpb25zKTtcclxuICBjb25zdCB7IHVwbG9hZCB9ID0gb3B0aW9ucztcclxuXHJcbiAgaWYgKCFoZWFkZXJzLkFjY2VwdCkge1xyXG4gICAgaGVhZGVycy5BY2NlcHQgPSBnZXRBY2NlcHRIZWFkZXIob3B0aW9ucyk7XHJcbiAgfVxyXG5cclxuICBpZiAoIXVwbG9hZCAmJiAhaXNHZXRNZXRob2Qob3B0aW9ucykgJiYgIWhlYWRlcnNbQ09OVEVOVF9UWVBFXSkge1xyXG4gICAgaGVhZGVyc1tDT05URU5UX1RZUEVdID0gb3B0aW9ucy5jb250ZW50VHlwZSB8fCBgJHtVUkxFTkNPREVEfTtjaGFyc2V0PXV0Zi04YDtcclxuICB9XHJcblxyXG4gIHJldHVybiBPYmplY3Qua2V5cyhoZWFkZXJzKS5yZWR1Y2UoKGFjYywga2V5KSA9PiB7XHJcbiAgICBpZiAoaXNEZWZpbmVkKGhlYWRlcnNba2V5XSkpIHtcclxuICAgICAgYWNjW2tleV0gPSBoZWFkZXJzW2tleV07XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYWNjO1xyXG4gIH0sIHt9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gcmVqZWN0SWZBYm9ydGVkKGRlZmVycmVkOiBEZWZlcnJlZFJlc3VsdCwgeGhyU3Vycm9nYXRlOiBYSFJTdXJyb2dhdGUsIGNhbGxiYWNrPzogKCkgPT4gdm9pZCkge1xyXG4gIGlmICh4aHJTdXJyb2dhdGUuYWJvcnRlZCkge1xyXG4gICAgZGVmZXJyZWQucmVqZWN0KHsgc3RhdHVzOiBTVEFUVVNfQUJPUlQsIHN0YXR1c1RleHQ6ICdhYm9ydGVkJywgb2s6IGZhbHNlIH0pO1xyXG4gICAgY2FsbGJhY2s/LigpO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0SnNvbnBQYXJhbWV0ZXJzKG9wdGlvbnM6IE9wdGlvbnMpIHtcclxuICBjb25zdCBwYXRjaGVkT3B0aW9ucyA9IHsgLi4ub3B0aW9ucyB9O1xyXG4gIGNvbnN0IGNhbGxiYWNrTmFtZSA9IGdldEpzb25wQ2FsbGJhY2tOYW1lKHBhdGNoZWRPcHRpb25zKTtcclxuXHJcbiAgcmV0dXJuIHsgY2FsbGJhY2tOYW1lLCBkYXRhOiBwYXRjaGVkT3B0aW9ucy5kYXRhIH07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGFkZEpzb25wQ2FsbGJhY2soY2FsbGJhY2tOYW1lOiBzdHJpbmcsIGRlZmVycmVkOiBEZWZlcnJlZFJlc3VsdCwgeGhyU3Vycm9nYXRlOiBYSFJTdXJyb2dhdGUpIHtcclxuICBnZXRXaW5kb3coKVtjYWxsYmFja05hbWVdID0gKGRhdGEpID0+IGRlZmVycmVkLnJlc29sdmUoZGF0YSwgU1VDQ0VTUywgeGhyU3Vycm9nYXRlKTtcclxufVxyXG5cclxuZnVuY3Rpb24gc2VuZFJlcXVlc3RCeVNjcmlwdCh1cmw6IHN0cmluZywgZGVmZXJyZWQ6IERlZmVycmVkUmVzdWx0LCB4aHJTdXJyb2dhdGU6IFhIUlN1cnJvZ2F0ZSkge1xyXG4gIGV2YWxDcm9zc0RvbWFpblNjcmlwdCh1cmwpLnRoZW4oXHJcbiAgICAoKSA9PiBkZWZlcnJlZC5yZXNvbHZlKG51bGwsIFNVQ0NFU1MsIHhoclN1cnJvZ2F0ZSksXHJcbiAgICAoKSA9PiBkZWZlcnJlZC5yZWplY3QoeGhyU3Vycm9nYXRlLCBFUlJPUiksXHJcbiAgKTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0UmVxdWVzdENhbGxiYWNrcyhvcHRpb25zOiBPcHRpb25zLCBkZWZlcnJlZDogRGVmZXJyZWRSZXN1bHQsIHhoclN1cnJvZ2F0ZTogWEhSU3Vycm9nYXRlKSB7XHJcbiAgcmV0dXJuIHtcclxuICAgIG5leHQocmVzcG9uc2U6IEh0dHBSZXNwb25zZTxhbnk+KSB7XHJcbiAgICAgIGlmIChpc1VzZWRKU09OUChvcHRpb25zKSkge1xyXG4gICAgICAgIHJldHVybiBvcHRpb25zLmNyb3NzRG9tYWluXHJcbiAgICAgICAgICA/IGRlZmVycmVkLnJlc29sdmUocmVzcG9uc2UsICdzdWNjZXNzJywgYXNzaWduUmVzcG9uc2VQcm9wcyh4aHJTdXJyb2dhdGUsIHJlc3BvbnNlKSlcclxuICAgICAgICAgIDogZXZhbFNjcmlwdChyZXNwb25zZS5ib2R5KTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKGlzVXNlZFNjcmlwdChvcHRpb25zKSkge1xyXG4gICAgICAgIGV2YWxTY3JpcHQocmVzcG9uc2UuYm9keSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiBkZWZlcnJlZC5yZXNvbHZlKFxyXG4gICAgICAgIHJlc3BvbnNlLmJvZHksXHJcbiAgICAgICAgcmVzcG9uc2UuYm9keSA/ICdzdWNjZXNzJyA6IE5PX0NPTlRFTlQsXHJcbiAgICAgICAgYXNzaWduUmVzcG9uc2VQcm9wcyh4aHJTdXJyb2dhdGUsIHJlc3BvbnNlKSxcclxuICAgICAgKTtcclxuICAgIH0sXHJcbiAgICBlcnJvcihlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpIHtcclxuICAgICAgZXJyb3IgPSBlcnJvciAmJiB0eXBlb2YgZXJyb3IgPT09ICdvYmplY3QnID8gZXJyb3IgOiB7IGVycm9yIH0gYXMgdW5rbm93biBhcyBIdHRwRXJyb3JSZXNwb25zZTtcclxuICAgICAgbGV0IGVycm9yU3RhdHVzID0gZXJyb3I/LnN0YXR1c1RleHQgPT09IFRJTUVPVVQgPyBUSU1FT1VUIDogJ2Vycm9yJztcclxuXHJcbiAgICAgIGVycm9yU3RhdHVzID0gb3B0aW9ucy5kYXRhVHlwZSA9PT0gJ2pzb24nICYmIGVycm9yPy5tZXNzYWdlPy5pbmNsdWRlcz8uKCdwYXJzaW5nJylcclxuICAgICAgICA/IFBBUlNFUl9FUlJPUlxyXG4gICAgICAgIDogZXJyb3JTdGF0dXM7XHJcblxyXG4gICAgICByZXR1cm4gZGVmZXJyZWQucmVqZWN0KGFzc2lnblJlc3BvbnNlUHJvcHMoeGhyU3Vycm9nYXRlLCB7IHN0YXR1czogNDAwLCAuLi5lcnJvciB9IGFzIEh0dHBFcnJvclJlc3BvbnNlKSwgZXJyb3JTdGF0dXMsIGVycm9yKTtcclxuICAgIH0sXHJcbiAgICBjb21wbGV0ZSgpIHtcclxuICAgICAgcmVqZWN0SWZBYm9ydGVkKGRlZmVycmVkLCB4aHJTdXJyb2dhdGUpO1xyXG4gICAgfSxcclxuICB9O1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRVcGxvYWRDYWxsYmFja3Mob3B0aW9uczogT3B0aW9ucywgZGVmZXJyZWQ6IERlZmVycmVkUmVzdWx0LCB4aHJTdXJyb2dhdGU6IFhIUlN1cnJvZ2F0ZSkge1xyXG4gIGxldCB0b3RhbCA9IDA7XHJcbiAgbGV0IGlzVXBsb2FkU3RhcnRlZCA9IGZhbHNlO1xyXG5cclxuICByZXR1cm4ge1xyXG4gICAgbmV4dDogKGV2ZW50OiBIdHRwRXZlbnQ8T2JqZWN0PikgPT4ge1xyXG4gICAgICBpZiAoIWlzVXBsb2FkU3RhcnRlZFxyXG4gICAgICAgICAgJiYgW0h0dHBFdmVudFR5cGUuVXBsb2FkUHJvZ3Jlc3MsIEh0dHBFdmVudFR5cGUuU2VudF0uaW5jbHVkZXMoZXZlbnQudHlwZSkpIHtcclxuICAgICAgICBvcHRpb25zLnVwbG9hZC5vbmxvYWRzdGFydD8uKGV2ZW50KTtcclxuICAgICAgICBpc1VwbG9hZFN0YXJ0ZWQgPSB0cnVlO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoZXZlbnQudHlwZSA9PT0gSHR0cEV2ZW50VHlwZS5VcGxvYWRQcm9ncmVzcykge1xyXG4gICAgICAgIHRvdGFsICs9IGV2ZW50LmxvYWRlZDtcclxuICAgICAgICBvcHRpb25zLnVwbG9hZC5vbnByb2dyZXNzPy4oeyAuLi5ldmVudCwgdG90YWwgfSk7XHJcbiAgICAgIH0gZWxzZSBpZiAoZXZlbnQudHlwZSA9PT0gSHR0cEV2ZW50VHlwZS5SZXNwb25zZSkge1xyXG4gICAgICAgIHJldHVybiBkZWZlcnJlZC5yZXNvbHZlKHhoclN1cnJvZ2F0ZSwgU1VDQ0VTUyk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9LFxyXG4gICAgZXJyb3IoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSB7XHJcbiAgICAgIGVycm9yID0gZXJyb3IgJiYgdHlwZW9mIGVycm9yID09PSAnb2JqZWN0JyA/IGVycm9yIDogeyBlcnJvciB9IGFzIHVua25vd24gYXMgSHR0cEVycm9yUmVzcG9uc2U7XHJcbiAgICAgIHJldHVybiBkZWZlcnJlZC5yZWplY3QoYXNzaWduUmVzcG9uc2VQcm9wcyh4aHJTdXJyb2dhdGUsIHsgc3RhdHVzOiA0MDAsIC4uLmVycm9yIH0gYXMgSHR0cEVycm9yUmVzcG9uc2UpLCBlcnJvci5zdGF0dXMsIGVycm9yKTtcclxuICAgIH0sXHJcbiAgICBjb21wbGV0ZSgpIHtcclxuICAgICAgcmVqZWN0SWZBYm9ydGVkKGRlZmVycmVkLCB4aHJTdXJyb2dhdGUsICgpID0+IHtcclxuICAgICAgICBvcHRpb25zLnVwbG9hZD8ub25hYm9ydD8uKHhoclN1cnJvZ2F0ZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICB9O1xyXG59XHJcblxyXG5leHBvcnQgY29uc3Qgc2VuZFJlcXVlc3RGYWN0b3J5ID0gKGh0dHBDbGllbnQ6IEh0dHBDbGllbnQpID0+IChvcHRpb25zOiBPcHRpb25zKSA9PiB7XHJcbiAgY29uc3QgYWJvcnQkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcclxuICBjb25zdCBkZWZlcnJlZDogRGVmZXJyZWRSZXN1bHQgPSBEZWZlcnJlZCgpO1xyXG4gIGNvbnN0IHJlc3VsdCA9IGRlZmVycmVkLnByb21pc2UoKSBhcyBSZXN1bHQ7XHJcbiAgY29uc3QgaXNHZXQgPSBpc0dldE1ldGhvZChvcHRpb25zKTtcclxuICBjb25zdCBpc0pTT05QID0gaXNVc2VkSlNPTlAob3B0aW9ucyk7XHJcbiAgY29uc3QgaXNTY3JpcHQgPSBpc1VzZWRTY3JpcHQob3B0aW9ucyk7XHJcblxyXG4gIG9wdGlvbnMuY3Jvc3NEb21haW4gPSBpc0Nyb3NzRG9tYWluKG9wdGlvbnMudXJsKTtcclxuICBvcHRpb25zLmNhY2hlID0gaXNDYWNoZU5lZWQob3B0aW9ucyk7XHJcblxyXG4gIGNvbnN0IGhlYWRlcnMgPSBnZXRSZXF1ZXN0SGVhZGVycyhvcHRpb25zKTtcclxuICBjb25zdCB4aHJTdXJyb2dhdGU6IFhIUlN1cnJvZ2F0ZSA9IHtcclxuICAgIHR5cGU6ICdYTUxIdHRwUmVxdWVzdFN1cnJvZ2F0ZScsXHJcbiAgICBhYm9ydGVkOiBmYWxzZSxcclxuICAgIGFib3J0KCkge1xyXG4gICAgICB0aGlzLmFib3J0ZWQgPSB0cnVlO1xyXG4gICAgICBhYm9ydCQubmV4dCgpO1xyXG4gICAgfSxcclxuICB9O1xyXG5cclxuICByZXN1bHQuYWJvcnQgPSAoKSA9PiB4aHJTdXJyb2dhdGUuYWJvcnQoKTtcclxuXHJcbiAgaWYgKCFvcHRpb25zLmNyb3NzRG9tYWluICYmIGlzSlNPTlApIHtcclxuICAgIGNvbnN0IHsgY2FsbGJhY2tOYW1lLCBkYXRhIH0gPSBnZXRKc29ucFBhcmFtZXRlcnMob3B0aW9ucyk7XHJcblxyXG4gICAgb3B0aW9ucy5kYXRhID0geyAuLi5vcHRpb25zLmRhdGEsIC4uLmRhdGEgfTtcclxuXHJcbiAgICBhZGRKc29ucENhbGxiYWNrKGNhbGxiYWNrTmFtZSwgZGVmZXJyZWQsIHhoclN1cnJvZ2F0ZSk7XHJcbiAgfVxyXG5cclxuICBjb25zdCB7IHVybCwgcGFyYW1ldGVyczogZGF0YSB9ID0gZ2V0UmVxdWVzdE9wdGlvbnMob3B0aW9ucywgaGVhZGVycyk7XHJcbiAgY29uc3QgeyB1cGxvYWQsIGJlZm9yZVNlbmQsIHhockZpZWxkcyB9ID0gb3B0aW9ucztcclxuXHJcbiAgYmVmb3JlU2VuZD8uKHhoclN1cnJvZ2F0ZSk7XHJcblxyXG4gIGlmIChvcHRpb25zLmNyb3NzRG9tYWluICYmIGlzU2NyaXB0ICYmICF4aHJTdXJyb2dhdGUuYWJvcnRlZCkge1xyXG4gICAgc2VuZFJlcXVlc3RCeVNjcmlwdCh1cmwsIGRlZmVycmVkLCB4aHJTdXJyb2dhdGUpO1xyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcblxyXG4gIGlmIChvcHRpb25zLmNhY2hlID09PSBmYWxzZSAmJiBpc0dldCAmJiBkYXRhKSB7XHJcbiAgICBkYXRhLl8gPSBEYXRlLm5vdygpICsgMTtcclxuICB9XHJcblxyXG4gIGNvbnN0IG1ha2VCb2R5ID0gKCkgPT4gKCF1cGxvYWQgJiYgdHlwZW9mIGRhdGEgPT09ICdvYmplY3QnICYmIGhlYWRlcnNbQ09OVEVOVF9UWVBFXS5pbmRleE9mKFVSTEVOQ09ERUQpID09PSAwXHJcbiAgICA/IE9iamVjdC5rZXlzKGRhdGEpLnJlZHVjZShcclxuICAgICAgKGh0dHBQYXJhbXMsIGtleSkgPT4gaHR0cFBhcmFtcy5zZXQoa2V5LCBkYXRhW2tleV0pLFxyXG4gICAgICBuZXcgSHR0cFBhcmFtcygpLFxyXG4gICAgKS50b1N0cmluZygpXHJcbiAgICA6IGRhdGEpO1xyXG5cclxuICBjb25zdCBib2R5ID0gaXNHZXQgPyB1bmRlZmluZWQgOiBtYWtlQm9keSgpO1xyXG4gIGNvbnN0IHBhcmFtcyA9IGlzR2V0ID8gZGF0YSA6IHVuZGVmaW5lZDtcclxuXHJcbiAgY29uc3QgcmVxdWVzdCA9IG9wdGlvbnMuY3Jvc3NEb21haW4gJiYgaXNKU09OUFxyXG4gICAgPyBodHRwQ2xpZW50Lmpzb25wKHVybCwgb3B0aW9ucy5qc29ucCB8fCAnY2FsbGJhY2snKVxyXG4gICAgOiBodHRwQ2xpZW50LnJlcXVlc3QoXHJcbiAgICAgIGdldE1ldGhvZChvcHRpb25zKSxcclxuICAgICAgdXJsLFxyXG4gICAgICB7XHJcbiAgICAgICAgcGFyYW1zLFxyXG4gICAgICAgIGJvZHksXHJcbiAgICAgICAgaGVhZGVycyxcclxuICAgICAgICByZXBvcnRQcm9ncmVzczogdHJ1ZSxcclxuICAgICAgICB3aXRoQ3JlZGVudGlhbHM6IHhockZpZWxkcz8ud2l0aENyZWRlbnRpYWxzLFxyXG4gICAgICAgIG9ic2VydmU6IHVwbG9hZCA/ICdldmVudHMnIDogJ3Jlc3BvbnNlJyxcclxuICAgICAgICByZXNwb25zZVR5cGU6IG9wdGlvbnMucmVzcG9uc2VUeXBlIHx8IChpc1NjcmlwdCB8fCBpc0pTT05QID8gJ3RleHQnIDogb3B0aW9ucy5kYXRhVHlwZSksXHJcbiAgICAgIH0sXHJcbiAgICApO1xyXG5cclxuICBjb25zdCBzdWJzY3JpcHRpb25DYWxsYmFja3MgPSB1cGxvYWRcclxuICAgID8gZ2V0VXBsb2FkQ2FsbGJhY2tzXHJcbiAgICA6IGdldFJlcXVlc3RDYWxsYmFja3M7XHJcblxyXG4gIHJlcXVlc3QucGlwZS5hcHBseShyZXF1ZXN0LCBbXHJcbiAgICB0YWtlVW50aWwoYWJvcnQkKSBhcyBhbnksXHJcbiAgICAuLi5vcHRpb25zLnRpbWVvdXRcclxuICAgICAgPyBbdGltZW91dFdpdGgob3B0aW9ucy50aW1lb3V0LCB0aHJvd0Vycm9yKHsgc3RhdHVzVGV4dDogVElNRU9VVCwgc3RhdHVzOiAwLCBvazogZmFsc2UgfSkpIGFzIGFueV1cclxuICAgICAgOiBbXSxcclxuICBdKS5zdWJzY3JpYmUoXHJcbiAgICBzdWJzY3JpcHRpb25DYWxsYmFja3Mob3B0aW9ucywgZGVmZXJyZWQsIHhoclN1cnJvZ2F0ZSksXHJcbiAgKTtcclxuXHJcbiAgcmV0dXJuIHJlc3VsdDtcclxufTtcclxuIl19